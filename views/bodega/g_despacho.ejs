<div class="row" style="margin: 0 ;padding-top: 0;margin-right: 2%;margin-left: 2%;background-color: white; height: 100%;">
<!--<h1 class="page-header">Crear Guía de Despacho:</h1>-->
<%
function largeID(string, large){
    if(string == null || string == ''){
        return 'Sin OF';
    }
    else{
        string = string.toString();
    }
    var ceros = '';
    var cant = Math.abs(large - string.length);
    for(var e=0; e < cant; e++){
        ceros += '0';
    }    
    return ceros+string;
}
function letraMayus(string) {
     return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
} 
%>
<div class="col-md-12 panel-creacion">
    <div class="panel panel-primary cargando-panel" style="display: none;">
            <div class="panel-heading">
                <div style="width: 100%;text-align: center;">
                    <img style="width: 25%" src="/loading.gif">
                </div>
            </div>
        </div>
        <div class="guardado_automatico" style="width: 100%;height: 20px" style="display: none;"></div>
    <%if(blanco){%>
        <form id="act_gdd" type="post">
    <%}else{%>
        <form id="send_gdd" type="post">
    <%}%>    
        <div class="panel panel-primary panel-defecto" >
            <div class="panel-heading" style="display: flex;">
                <div style="width: 50%">
                    <h3>Crear Guía de Despacho N° <%=num%></h3>
                    <!--<div>
                        <button class="btn btn-primary saveStateButton"><i class="glyphicon glyphicon-floppy-save"></i> Guardar</button>
                        <button class="btn btn-primary loadStateButton"><i class="glyphicon glyphicon-floppy-open"></i> Cargar</button>
                    </div>-->
                </div>

                    <label style="width: 30%">
                        Cliente: 
                        <select name="cliente_gd" class="form-control" id="cliente_gd">
                            <%for(var w=0; w < cli.length; w++){%>
                                <option value="<%= cli[w].idcliente%>" id="cli<%= cli[w].idcliente%>"><%= cli[w].sigla%> - <%= cli[w].razon%></option>
                            <%}%>
                        </select>
                    </label>
            </div>
            <table id="DataTableCGD" class="table table-striped">
                <thead>
                    <tr>
                        <th>N° OC</th>
                        <th>Item</th>
                        <th>Detalle</th>
                        <th>Sin Enviar</th>
                        <th>En Stock</th>
                        <th>A Enviar</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="session_prod">
                    <tr id="0">
                        <td>No hay productos añadidos</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <div class="panel-footer" style="display: flex;">
                <div class="form-inline divSelect" style="margin-left: 70%;">
                    <select name="estado" id="estadoselect" class="form-control">
                        <option value="Venta" class="notT">Venta</option>
                        <option value="Traslado">Traslado</option>
                        <option value="Devolucion" class="notT">Devolución</option>
                        <option value="Otro" class="notT">Otro</option>
                        <option value="Blanco" class="notT">Blanco</option>
                    </select>
                    <button type="button" class="btn btn-info" data-target="#gddobs" data-toggle="collapse">+ <i class="fa fa-comment"></i></button>
                    <button class="btn btn-success" type="submit">+ Crear</button>
                </div>
                <div class="form-group collapse" id="gddobs" style="margin-top:15px">
                    <textarea name="obs" class="form-control" style="margin-left:10%; width:80%;margin-right:10%" rows="4" placeholder="Observaciones"></textarea>
                </div>
            </div>
        </div>
    </form>

</div>

<style type="text/css">
    #nolanzados_wrapper{
        padding: 1%;
    }
    .dataTables_filter {
       position: relative;
       left: -835px;
       max-width: 100%;
       width: 100%;
    }
</style>

<div class="col-sm-12 col-md-12 col-md-offset-0">
        
    <ul class="nav nav-tabs" style="box-shadow: 0 0px 0px;">
        <li class="pestana_xdespachar active"><a data-toggle="tab" href="#prodxdeps">Productos por Despachar</a></li>
        <li class="pestana_insumos"><a data-toggle="tab" href="#insum">Insumos</a></li>
    </ul>

    <div class="tab-content">     
        <div class="tab-pane fade in active" id="prodxdeps">                
            <div class="panel panel-default">
                <div class="panel-body" style="padding: 0; padding-top: 10px">
                    <table id="DataTableGD" class="o_list_view table table-condensed table-striped o_list_view_ungrouped" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>N°OC</th>
                                <th>N°OF</th>
                                <th>Item</th>
                                <th>Detalle</th>
                                <th>Aleación</th>
                                <th>Sin Despachar</th>
                                <th>En Stock</th>
                                <th class="hidden">A Enviar</th>
                                <th>Fecha de Entrega</th>
                                <th></th>
                                <th class="hidden"></th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                        <%
                        var stateButton;
                        for(var i=0; i< data.length; i++){
                            stateButton = 'true';
                            if(data[i].stock <= 0){
                                stateButton = 'false';
                            }%>
                            <tr id="<%=data[i].idfabricaciones%>">
                                <td><%= largeID(data[i].numordenfabricacion, 6)%></td>
                                <td id="nof<%=data[i].idfabricaciones%>"><%= largeID(data[i].numof, 6)%></td>
                                <td><%= data[i].numitem%></td>
                                <td><%= letraMayus(data[i].detalle)%></td>
                                <td id="anom<%=data[i].idfabricaciones%>" style="text-align: center;"><%=data[i].anom%></td>
                                
                                <td style="text-align: center;" class="parsear_nro"><%= data[i].cantidad - data[i].despachados %></td>
                                
                                <td style="text-align: center;" class="parsear_nro"><%= data[i].stock %></td>
                                
                                <td class="hidden" id="in<%= data[i].idfabricaciones%>" style="padding: 2px"><input type="number" min="1" max="<%= data[i].cantidad - data[i].despachados %>" class="form-control" placeholder="1" style="width: 80px;margin: 0"></td>
                                
                                <td id="date<%= data[i].idfabricaciones%>" style="text-align: center;"><%= new Date(data[i].f_entrega).toLocaleDateString()%></td>

                                <td id="add<%= data[i].idfabricaciones%>">
                                    <a onclick="add_row(this)" data-idfab="<%= data[i].idfabricaciones%>" class="btn btn-success btn-xs"><span class="glyphicon glyphicon-plus" style="padding-left: 2px"></span></a>
                                </td>
                                
                                <td class="hidden" id="rmv<%= data[i].idfabricaciones%>">
                                    <a onclick="remove_row(this)" data-idfab="<%= data[i].idfabricaciones%>" class="btn btn-danger btn-xs"><span class="glyphicon glyphicon-remove" style="padding-left: 1px"></span></a>
                                </td>
                            </tr>
                        <%}%>
                        </tbody>
                    </table>
                    <!-- FILTRO PARA OBTENER LOS PRODUCTOS Y TABLA POR DESPACHAR, se cambio por Datatable!
                    <table class="table table-striped table-hover table-bordered" id="nolanzados">
                        <thead>
                            <tr>
                                <th>N°OC</th>
                                <th>N°OF</th>
                                <th>Item</th>
                                <th>Detalle</th>
                                <th>Aleación</th>
                                <th>Sin Despachar</th>
                                <th>En Stock</th>
                                <th>Fecha de Entrega</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <%
                            var stateButton;
                            for(var i=0; i< data.length; i++){
                                stateButton = 'true';
                                if(data[i].stock <= 0){
                                    stateButton = 'false';
                                }%>
                                <tr id="<%=data[i].idfabricaciones%>">
                                    <td><%= largeID(data[i].numordenfabricacion, 6)%></td>
                                    <td><%= largeID(data[i].numof, 6)%></td>
                                    <td><%= data[i].numitem%></td>
                                    <td><%= letraMayus(data[i].detalle)%></td>
                                    <td style="text-align: center;"><%=data[i].anom%></td>
                                    <td style="text-align: center;" class="parsear_nro"><%= data[i].cantidad - data[i].despachados %></td>
                                    <td style="text-align: center;" class="parsear_nro"><%= data[i].stock %></td>
                                    <td style="text-align: center;"><%= new Date(data[i].f_entrega).toLocaleDateString()%></td>
                                    <td><a onclick="send_queue(this)"
                                           data-notstock="<%=stateButton%>"
                                           data-num="<%=data[i].numordenfabricacion%>"
                                           data-idmat="<%= data[i].idmaterial%>"
                                           data-stock="<%= data[i].stock%>"
                                           data-sinenviar="<%= data[i].cantidad - data[i].despachados%>"
                                           data-cantidad="<%= data[i].cantidad%>"
                                           data-detalle="<%=data[i].detalle%>"
                                           data-id="<%= data[i].idfabricaciones%>"
                                           data-idof="<%= data[i].idordenfabricacion%>"
                                           data-numitem="<%= data[i].numitem%>"
                                           data-idcli="<%= data[i].idcliente%>"
                                           data-insu='0'
                                           class="btn btn-success addqq">
                                            <i class="glyphicon glyphicon-plus"></i>
                                        </a>
                                    </td>
                                </tr>
                            <%}%>
                        </tbody>
                    </table>
                        <div style="display: flex;">
                            <div style="width: 45%; margin-right: 5%;">
                                <small for="detProducto" style="width: 100%;margin-top: 5px">Buscador:</small>
                                <input placeholder="Ej: Inserto 23023 R2" class="form-control" style="width: 100%" id="detProducto">
                            </div>
                            <div style="width: 50%;" class="form-group">
                                  <small for="filtro" style="width: 100%;margin-top: 5px">Ordenar por:</small>
                                  <div style="display: flex;">
                                  <select style="width: 40%" class="form-control" id="filtro" onchange="refreshGDList()">
                                    <option value="odc.numoc">N° OC</option>
                                    <option value="material.detalle">Detalle</option>
                                    <option value="subaleacion.subnom">Aleación</option>
                                    <option value="pedido.cantidad - pedido.despachados">Sin Despachar</option>
                                    <option value="pedido.f_entrega" selected="selected">Fecha de Entrega</option>
                                  </select>
                                  <select style="width: 40%" class="form-control" id="orden" onchange="refreshGDList()">
                                    <option value="ASC" selected="selected">Ascendente</option>
                                    <option value="DESC">Descendente</option>
                                  </select>
                                  
                                        
                                  </div>
                                  <div class="checkbox">
                                    <label><input type="checkbox" id="only_one_odc">Solo una OC</label>
                                  </div>
                            </div>
                        </div>
                     -->
                </div>
            </div>
        </div>
        <div class="tab-pane fade in active" id="insum">
            <div class="panel panel-default">
                <div class="panel-heading" style="display: flex;">
                    <div style="width: 45%; margin-right: 5%;">
                        <small for="detProducto" style="width: 100%;margin-top: 5px">Buscador:</small>
                        <div style="display: flex;">
                            <input placeholder="Ej: Arena Cromita" class="form-control" style="width: 100%" id="detInsumo">
                            <button class="btn btn-primary buscar_insumo">Buscar <i class="fa fa-search"></i></button>
                        </div>
                    </div>
                    <h3 style="width: 55%">
                        <small class="pull-right">¡Guía de Despacho solo para Traslado!</small>
                    </h3>
                </div>
                <div class="panel-body">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                    <tr>
                        <th>Detalle</th>
                        <th>Stock</th>
                        <th>Unidad</th>
                        <th>Añadir</th>
                    </tr>
                    </thead>
                    <tbody class="tabla_insumos" id="tbody">
                    </tbody>
                </table>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Funcion para parsear nros -->
<script src="parsear_nro.js"></script>

<script type="text/javascript">

    // Tabla superior(TS)
    $('#DataTableCGD').DataTable( {
        "lengthChange": false,
        "searching": false,
        "bInfo": false,
        "paging": false
    });

    // Tabla inferior(TI)
    $('#DataTableGD').DataTable( {
        "lengthChange": false,
        "paging": false
    });

    //Funcion para agregar datos de la tabla inferior a la superior
    function add_row(yo){
        var row = $(yo);
        $("#0").addClass("hidden");                             //Oculta la primera fila en TS
        $("#" + row.data('idfab')).addClass("hidden");          //Oculta la fila en TI
        $("#rmv" + row.data('idfab')).removeClass("hidden");    //Muestra el boton eliminar en TS
        $("#nof" + row.data('idfab')).addClass("hidden");       //Oculta el N°OF en TS
        $("#anom" + row.data('idfab')).addClass("hidden");      //Oculta la Aleacion en TS
        $("#date" + row.data('idfab')).addClass("hidden");      //Oculta la fecha en TS
        $("#add" + row.data('idfab')).addClass("hidden");       //Oculta el boton agregar en TS
        $("#in" + row.data('idfab')).removeClass("hidden");     //Muestra input en TS
        $("#session_prod").append("<tr id='TS" + row.data('idfab') + "'>"+$("#" + row.data('idfab')).html()+"</tr>"); //Agrega fila de TI en TS
    }

    //Funcion para eliminar datos de la tabla inferior a la superior
    function remove_row(yo){
        var row = $(yo);
        $("#TS" + row.data('idfab')).remove(); //Elimina la fila
        $("#" + row.data('idfab')).removeClass("hidden");       //Muestra la fila en TI
        $("#rmv" + row.data('idfab')).addClass("hidden");    //Oculta el boton eliminar en TS
        $("#nof" + row.data('idfab')).removeClass("hidden");       //Muestra el N°OF en TS
        $("#anom" + row.data('idfab')).removeClass("hidden");      //Muestra la Aleacion en TS
        $("#date" + row.data('idfab')).removeClass("hidden");      //Muestra la fecha en TS
        $("#add" + row.data('idfab')).removeClass("hidden");       //Muestra el boton agregar en TS
        $("#in" + row.data('idfab')).addClass("hidden");     //Oculta input en TS
    }

    $('.nav-tabs a').click(function (e) {
      e.preventDefault();
      $(this).tab('show');
      if($(this).attr('href') == "#insum"){
        $('.divSelect option[value="Traslado"]').prop('selected', true);
        $(".notT").css('display', 'none');
      }
      else{
        $('.divSelect option[value="Venta"]').prop('selected', true);
        $(".notT").css('display', 'block');
      }
    });

    $(".buscar_insumo").on('click', function(e){
        e.preventDefault();
        $.ajax({
            type: 'GET',
            url: '/bodega/buscar_insumos/'+$("#detInsumo").val(),
            success: function(data){
                $(".tabla_insumos").html(data);
            }
        });
    });


    var obj = undefined;
    var auxer;
    var selection = [];
    function send_queue(e){
        obj = $(e).data();
        if(obj.notstock){
            if($(e).data('idcli')){
                //alert($(e).data('idcli') );
            }
            //console.log(obj);
            $.ajax({
                    type: 'POST',
                    data: obj,
                    url: 'bodega/add_despacho',
                    success: function(data){
                        $("#session_prod").html(data);
                        console.log(data);
                        if($("#only_one_odc").prop('checked') ){
                            $("#tbody tr a.addqq").each(function(e){
                                auxer = $(this).data();
                                if(parseInt(auxer.idof) != parseInt(obj.idof)){
                                    $("#" + auxer.id).remove();
                                }
                            });
                            selection.push(obj);
                            $("#" + obj.id).remove();
                        }
                    }
            });
        }
    }
    
    function refreshGDList(){
        $.ajax({
            type: 'POST',
            data: {fill: $("#filtro").val(),  orden: $("#orden").val() , detalle: $("#detProducto").val()},
            url: 'bodega/crear_gdd_fill',
            success: function(data){  
                $("#nolanzados").html(data);
                if(obj){
                    if($("#only_one_odc").prop('checked') ){
                        $("#tbody tr a.addqq").each(function(e){
                            auxer = $(this).data();
                            if(parseInt(auxer.idof) != parseInt(obj.idof)){
                                $("#" + auxer.id).remove();
                            }
                        });
                        console.log("SELECTION");
                        console.log(selection);
                        $("#tbody tr a.addqq").each(function(e){
                            auxer = $(this).data();
                            console.log(auxer);
                            for(var t=0; t < selection.length ; t++){
                                if(parseInt(auxer.id) == parseInt(selection[t].id)){
                                    $("#" + auxer.id).remove();
                                }
                            }
                        });
                    } 
                }

                //$("#" + obj.id).remove();                   
            }
        });
    }
    
    function dropDespacho(yo){
        var idfab = $(yo).data('id');
        $.ajax({
            type: 'POST',
            data: {idfab: idfab},
            url: 'bodega/drop_despacho',
            success: function(data){
                $("#session_prod").html(data);
                if($("#only_one_odc").prop('checked') ){
                    $("#tbody tr a.addqq").each(function(e){
                        auxer = $(this).data();
                        if(parseInt(auxer.idof) != parseInt(obj.idof)){
                            $("#" + auxer.id).remove();
                        }
                    });
                    if(selection.length == 1){
                        selection = [];
                        obj = undefined;
                    }
                    else{
                        for(var w=0; w < selection.length; w++){
                            if(idfab == selection[w].id){
                                selection = selection.splice(w,1)
                            }
                        }
                    }
                }
                var c=0;
                $("#session_prod tr").each(function(){
                    c++;
                })
                if(c==0){
                    $(".pestana_xdespachar").css('display', 'block');
                }
                refreshGDList();
            }
    });
    }
    $("#detProducto").on('keyup', function(e){
        refreshGDList();
    });
    $("form#send_gdd").on('submit',function(e){
        e.preventDefault();
        var aux = [];
        $("#session_prod input.form-control").each(function(e){
            aux.push([$(this).data('id'),$(this).data('idmat'), this.value]);
        });
        var est = $("#estadoselect").val();
        if(aux.length == 0){
            conf = confirm("¿Esta seguro que desea crear la GDD en blanco?");
            est = "Blanco";
        } else {
            conf = confirm("¿Esta seguro que desea crear esta GDD?")
        }
        if(conf){
            $.ajax({
                type: 'POST',
                data: {
                    list: aux,
                    estado: est,
                    obs:$("#gddobs .form-control").val(),
                    idcliente: $("#cliente_gd").val()
                },
                url: 'bodega/save_gdd',
                success: function(data){
                    alert("Guía Creada!")
                    $("#page-wrapper").html(data);
                }
            
            });
        }
    });
    $("form#act_gdd").on('submit',function(e){
        e.preventDefault();
        var aux = [];
        $("#session_prod input.form-control").each(function(e){
            aux.push(this.value);
        });
        var conf = true;
        var est = $("#estadoselect").val();
        conf = confirm("¿Esta seguro?");
        $.ajax({
                type: 'POST',
                data: {
                    list: aux,
                    estado: est,
                    idgdd: <%= num%>,
                    obs:$("#gddobs .form-control").val(),
                    idcliente: $("select[name = 'cliente_gd']").val()
                },
                url: 'bodega/act_gdd',
                success: function(data){
                    alert("Guía Creada!")
                    $("#page-wrapper").html(data);
                }
            
            });
  
        
    });
    /*$(".saveStateButton").on('click', function(e){
        e.preventDefault();
        var lista = $("form#send_gdd").serializeArray();
        console.log(lista);
        var data = {
            idped: [],
            cants: [],
            estado: '',
            obs: ''
        }
        for(var i =0;i<$("form#send_gdd").serializeArray().length;i++){
            if(lista[i].name != 'estado' && lista[i].name != 'obs'){
                data[lista[i].name].push(lista[i].value);
            } else{
                data[lista[i].name] = lista[i].value;
            }
        }
        console.log(data);
        $.ajax({
            type: 'POST',
            data: data,
            url: '/bodega/saveStateGDBD',
            beforeSend: function(xhr){
                //alert("Guardando!!");

                $(".guardado_automatico").text("Guardando estado de GD ...");
            },
            success: function(data){
                //alert("Estado de OC guardado");
                $(".guardado_automatico").text("Guardado por ultima vez: "+ new Date().toLocaleString());

            }
        });
    });

    $(".loadStateButton").on('click', function(e){
        e.preventDefault();
        $.ajax({
            type: 'GET',
            url: '/bodega/loadStateGDBD',
            beforeSend: function(xhr){
                $(".guardado_automatico").css('display', 'none');
                $(".panel-defecto").css('display', 'none');
                $(".cargando-panel").css('display', 'block');

                setTimeout(function(){  }, 1000);
            },
            success: function(data){
                obj = undefined;
                refreshGDList();
                var text = $(".guardado_automatico").text();
                $(".panel-creacion").html(data);
                $(".guardado_automatico").text(text);
            }
        });
    });*/

  </script>  
</div>