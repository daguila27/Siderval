
<%
function numberWithCommas(x){
	var parts = x.toString().split(".");
	parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
	return parts.join(",");
}
 %>
<style type="text/css">
	#tablaStock_wrapper{
		padding: 1%;
	}
</style>
<h2>Registrar Retiro</h2>
<div class="panel panel-primary">
	<form id="session_form">
		<div class="panel-heading">Retiro Actual:</div>
		<div class="panel-body">
			<label for="receptor">Nombre del receptor</label>
			<input type="text" class="form-control" id="receptor_r" name="receptor" required>
			<label for="etapa">Etapa</label>
			<select class="form-control" id="etapa_r" name="etapa" required>
				<option disabled selected>-- Selecciona una etapa --</option>
				<option value="1">Moldeo</option>
				<option value="2">Fusión</option>
				<option value="3">Quiebre</option>
				<option value="4">Terminación</option>
				<option value="5">Tratamiento Térmico</option>
				<option value="6">Maestranza</option>
				<option value="7">Control De Calidad</option>
			</select>
			<div class="form-group" style="margin-top: 10px">
				<button class="btn btn-success pull-right" type="submit">Registrar</button>
			</div>
		</div>
		<table id="tabla_session" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
			<thead>
			<tr>
				<th>Código</th>
				<th>Detalle</th>
				<th>Stock</th>
				<th></th>
				<th>A Enviar</th>
			</tr>
			</thead>
			<tbody id="session_rows">
			</tbody>
		</table>
	</form>
</div>
<div class="panel panel-default">
	<div class="panel-heading">Registrar Retiro:</div>
	<table id="tablaStock" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
		<thead>
			<tr>
				<th>Código</th>
				<th>Detalle</th>
				<th>Stock</th>
				<th></th>
			</tr>
		</thead>
		<tbody>
			<%if(mat.length > 0){
			for(var j=0; j < mat.length; j++){%>
			<tr id="row<%= mat[j].idmaterial%>">
				<td><%= mat[j].codigo%></td>
				<td><%= mat[j].detalle%></td>
				<td><%= numberWithCommas(mat[j].stock)%></td>
				<td><a href="#" class="selector" onclick="add_session(<%= mat[j].idmaterial%>,<%= mat[j].stock%>)"><i class="fa fa-plus"></i></a></td>
			</tr>
			<%}
			}
			else{%>
			<tr>
				No hay materiales registrados.
			</tr>
			<%}%>
		</tbody>
	</table>
</div>
<script type="text/javascript">
    //setDataTable("#tablaStock");
    $('#tablaStock').DataTable( {
        "scrollY":        "300px",
        "scrollCollapse": true,
        "paging":         false

    } );
    //  mat[Math.floor((Math.random()*mat.length)+1) - 1].detalle"
    function drop_session(idmaterial){
        $("#row" + idmaterial.toString()).removeClass("hidden");
        $("#sess" + idmaterial.toString()).remove();
    }
    function add_session(idmaterial,stock){
        var string_idm = idmaterial.toString();
        $("#tabla_session").append("<tr id='sess" + string_idm +"'>" + $("#row" + string_idm).html() + "<td><input type='number' class='material-form form-control' data-idmaterial='" + string_idm + "'></td></tr>");
		$("#sess" + string_idm + " > td > .selector").attr("onclick","drop_session(" + string_idm + ")");
        $("#sess" + string_idm + " > td > .selector > i").attr("class","fa fa-remove");
        $("#row" + idmaterial.toString()).addClass("hidden");
    }
    $("#session_form").submit(function (e){
        e.preventDefault();
        var lista_m = [];
        var lista_v = [];
        $("#session_rows > tr > td > input").each(function(e){
           lista_m.push($(this).data('idmaterial'));
           lista_v.push(this.value);
		});
        if(lista_m.length){
            $.ajax({
                type: 'post',
				data: {
                    lista_m: lista_m,
					lista_v: lista_v,
					etapa: $("#etapa_r").val(),
					receptor: $("#receptor_r").val()
				},
                url: '/matprimas/save_retiro',
                success: function(data) {
                    if(!data.err){
                        alert(data.msg);
                        $("#create_retiro").trigger("click");
					} else alert(data.msg);
                }
            });

		} else alert("No hay Materiales seleccionados")
	})
</script>